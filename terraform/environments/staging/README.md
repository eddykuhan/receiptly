# Receiptly Terraform - Staging Environment

This Terraform configuration manages the essential AWS resources for Receiptly:

## Resources Created

1. **S3 Bucket** - Receipt image storage with versioning and lifecycle policies
2. **IAM User** - Dedicated user with S3-only access permissions
3. **AWS Secrets Manager** - Secure storage for:
   - Database credentials (username & password)
   - S3 access credentials (access key & secret key)

## Prerequisites

1. AWS CLI configured with appropriate credentials
2. Terraform >= 1.0
3. S3 backend already set up (see main terraform README)

## Quick Start

### 1. Initialize Terraform

```bash
cd terraform/environments/staging
terraform init
```

### 2. Plan Changes

```bash
terraform plan
```

### 3. Apply Configuration

```bash
terraform apply
```

## What Gets Created

### S3 Bucket
- **Name**: `receiptly-staging-receipts`
- **Features**:
  - Versioning enabled
  - Server-side encryption (AES256)
  - Public access blocked
  - Lifecycle policy: Delete after 365 days

### IAM User
- **Name**: `receiptly-staging-s3-user`
- **Permissions**: Limited to S3 bucket operations only
  - `s3:PutObject` - Upload receipts
  - `s3:GetObject` - Download receipts
  - `s3:DeleteObject` - Delete receipts
  - `s3:ListBucket` - List bucket contents

### Secrets Manager Secrets

#### 1. Database Credentials
- **Name**: `receiptly/database/credentials`
- **Contains**:
  ```json
  {
    "username": "postgres",
    "password": "<auto-generated-32-char-password>"
  }
  ```

#### 2. S3 Access Credentials
- **Name**: `receiptly/s3/credentials`
- **Contains**:
  ```json
  {
    "aws_access_key_id": "<generated-access-key>",
    "aws_secret_access_key": "<generated-secret-key>",
    "bucket_name": "receiptly-staging-receipts",
    "region": "ap-southeast-1"
  }
  ```

## Retrieve Credentials

After applying, retrieve the credentials:

### Database Credentials

```bash
# Get full credentials
aws secretsmanager get-secret-value \
  --secret-id receiptly/database/credentials \
  --query SecretString \
  --output text | jq

# Get just the password
aws secretsmanager get-secret-value \
  --secret-id receiptly/database/credentials \
  --query SecretString \
  --output text | jq -r '.password'
```

### S3 Credentials

```bash
# Get full S3 credentials
aws secretsmanager get-secret-value \
  --secret-id receiptly/s3/credentials \
  --query SecretString \
  --output text | jq

# Export as environment variables
export AWS_ACCESS_KEY_ID=$(aws secretsmanager get-secret-value \
  --secret-id receiptly/s3/credentials \
  --query SecretString \
  --output text | jq -r '.aws_access_key_id')

export AWS_SECRET_ACCESS_KEY=$(aws secretsmanager get-secret-value \
  --secret-id receiptly/s3/credentials \
  --query SecretString \
  --output text | jq -r '.aws_secret_access_key')
```

## Using in Application

### .NET API (appsettings.json)

Retrieve from Secrets Manager on startup:

```csharp
// Retrieve S3 credentials from Secrets Manager
var s3Credentials = await secretsManager.GetSecretValueAsync(
    new GetSecretValueRequest { SecretId = "receiptly/s3/credentials" }
);
var s3Config = JsonSerializer.Deserialize<S3Config>(s3Credentials.SecretString);

// Configure AWS SDK
var awsCredentials = new BasicAWSCredentials(
    s3Config.AwsAccessKeyId, 
    s3Config.AwsSecretAccessKey
);
```

### Python OCR Service

```python
import boto3
import json

# Get S3 credentials
secrets_client = boto3.client('secretsmanager', region_name='ap-southeast-1')
response = secrets_client.get_secret_value(SecretId='receiptly/s3/credentials')
s3_creds = json.loads(response['SecretString'])

# Create S3 client with credentials
s3_client = boto3.client(
    's3',
    aws_access_key_id=s3_creds['aws_access_key_id'],
    aws_secret_access_key=s3_creds['aws_secret_access_key'],
    region_name=s3_creds['region']
)
```

## Outputs

After `terraform apply`, you'll see:

- `receipts_bucket_name` - S3 bucket name
- `receipts_bucket_arn` - S3 bucket ARN
- `s3_user_name` - IAM user name
- `db_secret_name` - Database secret name
- `s3_secret_name` - S3 credentials secret name
- `setup_complete` - Quick reference guide

## Variables

Customize in `terraform.tfvars`:

```hcl
aws_region   = "ap-southeast-1"
project_name = "receiptly"
environment  = "staging"
db_username  = "postgres"
```

## Security Best Practices

1. **Never commit credentials** to version control
2. **Rotate access keys** regularly (every 90 days)
3. **Use IAM roles** instead of access keys when possible (for EC2, ECS, Lambda)
4. **Enable CloudTrail** to monitor S3 access
5. **Use Secrets Manager** auto-rotation for database passwords

## Clean Up

To destroy all resources:

```bash
terraform destroy
```

**Warning**: This will:
- Delete the S3 bucket and all stored receipts
- Delete the IAM user and access keys
- Delete secrets from Secrets Manager (with 7-day recovery window)

## Cost Estimation

- **S3**: ~$0.023/GB/month + request costs
- **Secrets Manager**: ~$0.40/month per secret × 2 = $0.80/month
- **IAM User**: Free
- **Estimated monthly cost**: < $2 (for typical staging usage)

## Troubleshooting

### Access Denied to S3

Ensure you're using the credentials from `receiptly/s3/credentials` secret, not your personal AWS credentials.

### Secret Not Found

Secrets have a 7-day recovery window. Check if they were recently deleted:

```bash
aws secretsmanager list-secrets --include-planned-deletion
```

## Next Steps

1. ✅ Configure your .NET API to retrieve S3 credentials from Secrets Manager
2. ✅ Update Python OCR service to use S3 credentials
3. ✅ Configure GitHub Actions to retrieve credentials
4. ✅ Set up your RDS instance separately (not managed by Terraform)
