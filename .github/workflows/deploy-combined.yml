name: Deploy API and OCR to EC2

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'dotnet-api/**'
      - 'python-ocr/**'
      - '.github/workflows/deploy-combined.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-southeast-1

jobs:
  build-and-deploy:
    name: Build and Deploy to EC2 - ${{ github.ref == 'refs/heads/develop' && 'staging' || github.ref == 'refs/heads/main' && 'production' || github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/develop' && 'staging' || github.ref == 'refs/heads/main' && 'production' || github.event.inputs.environment }}
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get EC2 instance details
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=receiptly-${{ github.ref == 'refs/heads/develop' && 'staging' || 'production' }}-app-server" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          
          INSTANCE_IP=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "ðŸ“ EC2 Instance: $INSTANCE_ID ($INSTANCE_IP)"

      - name: Get credentials from Secrets Manager
        id: secrets
        run: |
          # Get Azure credentials
          AZURE_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id receiptly/azure/credentials \
            --query 'SecretString' \
            --output text)
          
          AZURE_ENDPOINT=$(echo "$AZURE_SECRET" | jq -r '.endpoint')
          AZURE_KEY=$(echo "$AZURE_SECRET" | jq -r '.api_key')
          
          # Get Database credentials
          DB_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id receiptly/database/credentials \
            --query 'SecretString' \
            --output text)
          
          DB_HOST=$(echo "$DB_SECRET" | jq -r '.host')
          DB_PORT=$(echo "$DB_SECRET" | jq -r '.port')
          DB_NAME=$(echo "$DB_SECRET" | jq -r '.database')
          DB_USER=$(echo "$DB_SECRET" | jq -r '.username')
          DB_PASS=$(echo "$DB_SECRET" | jq -r '.password')
          
          # Get S3 credentials
          S3_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id receiptly/s3/credentials \
            --query 'SecretString' \
            --output text)
          
          S3_BUCKET=$(echo "$S3_SECRET" | jq -r '.bucket_name')
          S3_REGION=$(echo "$S3_SECRET" | jq -r '.region')
          
          echo "azure_endpoint=$AZURE_ENDPOINT" >> $GITHUB_OUTPUT
          echo "azure_key=$AZURE_KEY" >> $GITHUB_OUTPUT
          echo "db_connection=Host=$DB_HOST;Port=$DB_PORT;Database=$DB_NAME;Username=$DB_USER;Password=$DB_PASS" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "s3_region=$S3_REGION" >> $GITHUB_OUTPUT
          echo "âœ… Retrieved all credentials from Secrets Manager"

      - name: Build .NET API Docker image
        run: |
          cd dotnet-api
          docker build --platform linux/amd64 -t receiptly-api:latest .

      - name: Build Python OCR Docker image
        run: |
          cd python-ocr
          docker build --platform linux/amd64 -t python-ocr:latest .

      - name: Save Docker images
        run: |
          docker save receiptly-api:latest | gzip > api-image.tar.gz
          docker save python-ocr:latest | gzip > ocr-image.tar.gz

      - name: Upload images to S3
        run: |
          aws s3 cp api-image.tar.gz s3://receiptly-terraform-state/deployments/api-image.tar.gz
          aws s3 cp ocr-image.tar.gz s3://receiptly-terraform-state/deployments/ocr-image.tar.gz
          echo "âœ… Uploaded Docker images to S3"

      - name: Create environment files
        run: |
          # Create .env for API
          cat > api.env <<EOF
          AWS__Region=${{ env.AWS_REGION }}
          ASPNETCORE_ENVIRONMENT=Production
          ASPNETCORE_URLS=http://+:5000
          EOF
          
          # Create .env for OCR
          cat > ocr.env <<EOF
          AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT=${{ steps.secrets.outputs.azure_endpoint }}
          AZURE_DOCUMENT_INTELLIGENCE_KEY=${{ steps.secrets.outputs.azure_key }}
          EOF
          
          # Upload to S3
          aws s3 cp api.env s3://receiptly-terraform-state/deployments/api.env
          aws s3 cp ocr.env s3://receiptly-terraform-state/deployments/ocr.env

      - name: Deploy to EC2 using SSM
        run: |
          echo "ðŸ“¦ Deploying to EC2 instance: ${{ steps.ec2.outputs.instance_id }}"
          
          # Execute deployment commands via SSM
          aws ssm send-command \
            --instance-ids "${{ steps.ec2.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "echo \"=== Downloading .NET API image ===\"",
              "cd /opt/receiptly/api",
              "aws s3 cp s3://receiptly-terraform-state/deployments/api-image.tar.gz .",
              "aws s3 cp s3://receiptly-terraform-state/deployments/api.env .env",
              "docker load < api-image.tar.gz",
              "systemctl restart receiptly-api",
              "echo \"=== Downloading Python OCR image ===\"",
              "cd /opt/receiptly/ocr",
              "aws s3 cp s3://receiptly-terraform-state/deployments/ocr-image.tar.gz .",
              "aws s3 cp s3://receiptly-terraform-state/deployments/ocr.env .env",
              "docker load < ocr-image.tar.gz",
              "systemctl restart receiptly-ocr",
              "echo \"=== Checking services ===\"",
              "systemctl status receiptly-api --no-pager || true",
              "systemctl status receiptly-ocr --no-pager || true",
              "docker ps",
              "echo \"âœ… Deployment complete\""
            ]' \
            --output text \
            --query 'Command.CommandId' > command_id.txt
          
          COMMAND_ID=$(cat command_id.txt)
          echo "ðŸ”„ Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          sleep 15
          
          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.ec2.outputs.instance_id }}" \
            --query 'StandardOutputContent' \
            --output text

      - name: Health Check
        run: |
          echo "ðŸ¥ Checking services health..."
          sleep 10
          
          API_URL="http://${{ steps.ec2.outputs.instance_ip }}:5000/health"
          OCR_URL="http://${{ steps.ec2.outputs.instance_ip }}:8000/health"
          
          # Check API
          for i in {1..5}; do
            if curl -f "$API_URL"; then
              echo "âœ… .NET API is healthy!"
              break
            fi
            echo "â³ Waiting for API... (attempt $i/5)"
            sleep 10
          done
          
          # Check OCR
          for i in {1..5}; do
            if curl -f "$OCR_URL"; then
              echo "âœ… Python OCR is healthy!"
              break
            fi
            echo "â³ Waiting for OCR... (attempt $i/5)"
            sleep 10
          done

      - name: Deployment Summary
        if: success()
        run: |
          echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref == 'refs/heads/develop' && 'Staging' || 'Production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Instance:** ${{ steps.ec2.outputs.instance_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "- **.NET API:** http://${{ steps.ec2.outputs.instance_ip }}:5000" >> $GITHUB_STEP_SUMMARY
          echo "- **Python OCR:** http://${{ steps.ec2.outputs.instance_ip }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** http://${{ steps.ec2.outputs.instance_ip }}:5000/health" >> $GITHUB_STEP_SUMMARY
          echo "- **OCR:** http://${{ steps.ec2.outputs.instance_ip }}:8000/health" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs:** http://${{ steps.ec2.outputs.instance_ip }}:5000/swagger" >> $GITHUB_STEP_SUMMARY
          echo "- **OCR Docs:** http://${{ steps.ec2.outputs.instance_ip }}:8000/docs" >> $GITHUB_STEP_SUMMARY
