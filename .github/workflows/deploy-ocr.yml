name: Deploy Python OCR to EC2

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'python-ocr/**'
      - '.github/workflows/deploy-ocr.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: ap-southeast-1

jobs:
  build-and-deploy:
    name: Build and Deploy to EC2 - ${{ github.ref == 'refs/heads/develop' && 'staging' || github.ref == 'refs/heads/main' && 'production' || github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/develop' && 'staging' || github.ref == 'refs/heads/main' && 'production' || github.event.inputs.environment }}
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get EC2 instance IP
        id: ec2
        run: |
          INSTANCE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=receiptly-${{ github.ref == 'refs/heads/develop' && 'staging' || 'production' }}-ocr-service" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "ðŸ“ EC2 Instance IP: $INSTANCE_IP"

      - name: Get Azure credentials from Secrets Manager
        id: secrets
        run: |
          # Retrieve Azure credentials from AWS Secrets Manager
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id receiptly/azure/credentials \
            --query 'SecretString' \
            --output text)
          
          AZURE_ENDPOINT=$(echo "$SECRET_JSON" | jq -r '.endpoint')
          AZURE_KEY=$(echo "$SECRET_JSON" | jq -r '.api_key')
          
          echo "azure_endpoint=$AZURE_ENDPOINT" >> $GITHUB_OUTPUT
          echo "azure_key=$AZURE_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Retrieved Azure credentials from Secrets Manager"

      - name: Create docker-compose.yml
        run: |
          cat > docker-compose.yml <<'EOF'
          version: '3.8'
          
          services:
            python-ocr:
              image: python-ocr:latest
              container_name: receiptly-ocr
              ports:
                - "8000:8000"
              environment:
                - AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT=${{ steps.secrets.outputs.azure_endpoint }}
                - AZURE_DOCUMENT_INTELLIGENCE_KEY=${{ steps.secrets.outputs.azure_key }}
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          EOF

      - name: Build Docker image
        run: |
          cd python-ocr
          docker build -t python-ocr:latest .

      - name: Save Docker image
        run: |
          docker save python-ocr:latest | gzip > python-ocr-image.tar.gz

      - name: Install SSH key
        run: |
          # For now, using instance connect or Systems Manager
          # If SSH key is needed, uncomment below:
          # mkdir -p ~/.ssh
          # echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          # chmod 600 ~/.ssh/id_rsa
          echo "Using AWS Systems Manager for deployment"

      - name: Deploy to EC2 using SSM
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=receiptly-${{ github.ref == 'refs/heads/develop' && 'staging' || 'production' }}-ocr-service" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          
          echo "ðŸ“¦ Deploying to EC2 instance: $INSTANCE_ID"
          
          # Copy files to EC2
          aws s3 cp python-ocr-image.tar.gz s3://receiptly-terraform-state/deployments/python-ocr-image.tar.gz
          aws s3 cp docker-compose.yml s3://receiptly-terraform-state/deployments/docker-compose.yml
          
          # Execute deployment commands via SSM
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "cd /opt/receiptly",
              "aws s3 cp s3://receiptly-terraform-state/deployments/python-ocr-image.tar.gz .",
              "aws s3 cp s3://receiptly-terraform-state/deployments/docker-compose.yml .",
              "docker load < python-ocr-image.tar.gz",
              "docker-compose down || true",
              "docker-compose up -d",
              "docker ps",
              "echo \"âœ… Deployment complete\""
            ]' \
            --output text \
            --query 'Command.CommandId' > command_id.txt
          
          COMMAND_ID=$(cat command_id.txt)
          echo "ðŸ”„ Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          sleep 10
          
          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text

      - name: Health Check
        run: |
          echo "ðŸ¥ Checking service health..."
          sleep 15
          
          HEALTH_URL="http://${{ steps.ec2.outputs.instance_ip }}:8000/health"
          
          for i in {1..5}; do
            if curl -f "$HEALTH_URL"; then
              echo "âœ… Service is healthy!"
              exit 0
            fi
            echo "â³ Waiting for service... (attempt $i/5)"
            sleep 10
          done
          
          echo "âŒ Service health check failed"
          exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "### Python OCR Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref == 'refs/heads/develop' && 'Staging' || 'Production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** http://${{ steps.ec2.outputs.instance_ip }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "**Health Check:** http://${{ steps.ec2.outputs.instance_ip }}:8000/health" >> $GITHUB_STEP_SUMMARY
          echo "**API Docs:** http://${{ steps.ec2.outputs.instance_ip }}:8000/docs" >> $GITHUB_STEP_SUMMARY
