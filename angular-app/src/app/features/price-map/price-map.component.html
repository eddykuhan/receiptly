<div class="flex flex-col h-screen bg-gradient-to-br from-base-200 via-base-100 to-base-200">
    <!-- Gradient Header with Glass Effect -->
    <header class="bg-gradient-to-r from-primary to-secondary p-6 shadow-lg relative overflow-hidden z-10">
        <!-- Animated background pattern -->
        <div class="absolute inset-0 opacity-10">
            <div
                class="absolute top-0 left-0 w-64 h-64 bg-white rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2">
            </div>
            <div
                class="absolute bottom-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl translate-x-1/2 translate-y-1/2">
            </div>
        </div>

        <div class="relative space-y-4">
            <div class="flex items-center gap-4">
                <div class="p-4 bg-white/20 backdrop-blur-sm rounded-2xl shadow-xl">
                    <span class="material-icons text-4xl text-white">map</span>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white mb-1">Price Map</h1>
                    <p class="text-white/90 text-sm">Find the cheapest stores</p>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="relative">
                <div class="form-control">
                    <div class="relative">
                        <span
                            class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-white/60">search</span>
                        <input type="text" placeholder="Search for products (e.g., milk, bread)..."
                            class="input input-bordered bg-white/20 backdrop-blur-sm text-white placeholder-white/60 border-white/30 w-full pl-10 pr-20"
                            [value]="searchQuery()" (input)="onSearchInput($any($event.target).value)"
                            (keyup.enter)="performSearch()" (focus)="showSuggestions.set(true)" />
                        @if (searchQuery()) {
                        <button
                            class="btn btn-ghost btn-sm btn-circle absolute right-12 top-1/2 -translate-y-1/2 text-white/80 hover:text-white"
                            (click)="clearSearch()">
                            <span class="material-icons text-lg">close</span>
                        </button>
                        }
                        <button class="btn btn-accent btn-sm absolute right-1 top-1/2 -translate-y-1/2"
                            (click)="performSearch()">
                            Search
                        </button>
                    </div>
                </div>

                <!-- Autocomplete Suggestions -->
                @if (showSuggestions() && getFilteredSuggestions().length > 0) {
                <div
                    class="absolute top-full mt-1 w-full bg-base-100 rounded-box shadow-xl border border-base-200 z-20">
                    <ul class="menu p-2">
                        @for (suggestion of getFilteredSuggestions(); track suggestion) {
                        <li>
                            <a (click)="selectSuggestion(suggestion)" class="text-sm">
                                <span class="material-icons text-base">shopping_basket</span>
                                {{ suggestion }}
                            </a>
                        </li>
                        }
                    </ul>
                </div>
                }
            </div>

            <!-- Results Summary -->
            @if (hasResults()) {
            <div class="mt-3 flex items-center gap-2 text-sm text-white/90">
                <span class="badge badge-accent">{{ searchResults().length }} stores found</span>
                <span class="text-white/80">Cheapest: {{ cheapestPrice() | myr }}</span>
            </div>
            }
        </div>
    </header>

    <!-- Main Content: Map + Side Panel -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Map Container -->
        <div class="flex-1 relative">
            <div id="map" class="w-full h-full"></div>

            @if (!hasResults() && !searchQuery()) {
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="bg-base-100/90 backdrop-blur-sm p-6 rounded-box shadow-xl text-center max-w-sm">
                    <span class="material-icons text-6xl text-primary mb-3">search</span>
                    <h3 class="font-bold text-lg mb-2">Search for Products</h3>
                    <p class="text-sm text-base-content/60">Enter a product name to find the cheapest stores near
                        you
                    </p>
                </div>
            </div>
            }
        </div>

        <!-- Side Panel (Desktop) -->
        @if (hasResults()) {
        <div class="hidden lg:block w-80 bg-base-100 border-l border-base-200 overflow-y-auto">
            <div class="p-4">
                <h2 class="font-bold text-lg mb-3 flex items-center gap-2">
                    <span class="material-icons text-primary">store</span>
                    Stores ({{ searchResults().length }})
                </h2>

                <div class="space-y-2">
                    @for (result of searchResults(); track result.store.id; let i = $index) {
                    <div class="card bg-base-200 hover:bg-base-300 cursor-pointer transition-colors"
                        [class.ring-2]="selectedStore() && selectedStore()!.store.id === result.store.id"
                        [class.ring-primary]="selectedStore() && selectedStore()!.store.id === result.store.id"
                        (click)="selectStore(result)">
                        <div class="card-body p-3">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        @if (i === 0) {
                                        <span class="badge badge-success badge-sm">Cheapest</span>
                                        }
                                        <span class="w-3 h-3 rounded-full" [class.bg-success]="i === 0"
                                            [class.bg-warning]="i > 0 && i < searchResults().length - 1"
                                            [class.bg-error]="i === searchResults().length - 1"></span>
                                    </div>
                                    <h3 class="font-bold text-sm truncate">{{ result.store.name }}</h3>
                                    <p class="text-xs text-base-content/60 truncate">{{ result.store.address }}</p>
                                    @if (result.distance) {
                                    <p class="text-xs text-base-content/50 mt-1">{{ result.distance.toFixed(1) }} km
                                        away</p>
                                    }
                                </div>
                                <div class="text-right">
                                    <p class="font-mono font-bold text-primary">{{ result.price | myr }}</p>
                                    <p class="text-xs text-base-content/50">{{ result.lastPurchaseDate | date:'MMM
                                        d' }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
        }
    </div>

    <!-- Mobile Bottom Sheet -->
    @if (hasResults()) {
    <div
        class="lg:hidden fixed bottom-0 left-0 right-0 bg-base-100 border-t border-base-200 max-h-[40vh] overflow-y-auto z-20">
        <div class="p-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-bold flex items-center gap-2">
                    <span class="material-icons text-primary">store</span>
                    {{ searchResults().length }} Stores
                </h2>
                <button class="btn btn-ghost btn-sm btn-circle" (click)="clearSearch()">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <div class="space-y-2">
                @for (result of searchResults(); track result.store.id; let i = $index) {
                <div class="card bg-base-200 hover:bg-base-300 cursor-pointer transition-colors"
                    (click)="selectStore(result)">
                    <div class="card-body p-3">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                @if (i === 0) {
                                <span class="badge badge-success badge-sm mb-1">Cheapest</span>
                                }
                                <h3 class="font-bold text-sm">{{ result.store.name }}</h3>
                                <p class="text-xs text-base-content/60">{{ result.store.address }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-mono font-bold text-primary">{{ result.price | myr }}</p>
                                @if (result.distance) {
                                <p class="text-xs text-base-content/50">{{ result.distance.toFixed(1) }} km</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
    }
</div>